name: Claude API Test

"on":
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  test-api:
    if: contains(github.event.issue.title, 'test-claude-api')
    runs-on: ubuntu-latest
    
    steps:
      - name: Test Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Testing Claude API connection..."
          
          # Check if API key exists
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ùå ANTHROPIC_API_KEY is not set!"
            exit 1
          fi
          
          echo "‚úÖ API key is set (length: ${#ANTHROPIC_API_KEY})"
          
          # Test API call with detailed error output
          RESPONSE=$(curl -v https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 100,
              "messages": [{
                "role": "user",
                "content": "Say hello"
              }]
            }' 2>&1)
          
          echo "Full response:"
          echo "$RESPONSE"
          
          # Try to extract error
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // "No error field"' 2>/dev/null || echo "Could not parse JSON")
          
          echo ""
          echo "Error message: $ERROR"
          
          # Save response
          echo "$RESPONSE" > api_test.txt

      - name: Post result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let result = 'Could not read test results';
            try {
              result = fs.readFileSync('api_test.txt', 'utf8');
            } catch (e) {
              result = 'Error reading file: ' + e.message;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üîç Claude API Test Results\n\n\`\`\`\n${result}\n\`\`\``
            });
