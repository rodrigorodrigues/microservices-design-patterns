name: Claude PR Review

"on":
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR diff
        id: pr_diff
        if: github.event_name == 'pull_request'
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          git diff $BASE_SHA..$HEAD_SHA > pr_diff.txt
          git diff --name-only $BASE_SHA..$HEAD_SHA > changed_files.txt
          
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Build prompt based on event type
          if [ "$EVENT_NAME" = "issue_comment" ]; then
            PROMPT="A user asked: $COMMENT_BODY. This is about PR #$PR_NUMBER. Please answer their question about this microservices PR."
          else
            DIFF_CONTENT=$(cat pr_diff.txt 2>/dev/null | head -c 30000 || echo "No diff available")
            CHANGED_FILES=$(cat changed_files.txt 2>/dev/null || echo "No files")
            PROMPT="Review this PR for microservices-design-patterns. Title: $PR_TITLE. Changed files: $CHANGED_FILES. Diff: $DIFF_CONTENT. This uses Java/Spring Boot, Kotlin, Node.js, Python, Go, MongoDB, Consul, Docker/Kubernetes, React, OAuth2/JWT. Check: 1) Architecture alignment, 2) Code quality, 3) Security concerns, 4) Testing, 5) Documentation needs. Be concise and actionable."
          fi
          
          # Escape and clean prompt
          PROMPT=$(echo "$PROMPT" | sed 's/"/\\"/g' | tr '\n' ' ' | head -c 15000)
          
          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2000,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"$PROMPT\"
              }]
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not generate review"' > claude_review.txt

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude_review.txt', 'utf8');
            
            const comment = `## ðŸ¤– Claude AI Review\n\n${review}\n\n---\n*Review powered by Claude Sonnet 4 â€¢ Reply with @claude for questions*`;
            
            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

      - name: Check for critical issues
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude_review.txt', 'utf8').toLowerCase();
            
            const criticalKeywords = [
              'security', 'vulnerability', 'critical', 'unsafe', 
              'sql injection', 'xss', 'hardcoded', 'secret'
            ];
            
            const hasCritical = criticalKeywords.some(keyword => review.includes(keyword));
            
            if (hasCritical) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: ['needs-security-review']
                });
              } catch (error) {
                console.log('Could not add label:', error.message);
              }
            }